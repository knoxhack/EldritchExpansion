// Build configuration for the "all" module which includes all modules
apply from: '../../common.gradle'

base {
    archivesName = "eldritch-void-all"
}

neoForge {
    mods {
        "eldritchvoid" {
            sourceSet(sourceSets.main)
            displayName = "Eldritch Void - Complete"
        }
    }
}

// Include resources generated by data generators.
sourceSets.main.resources {
    srcDir 'src/generated/resources'
}

dependencies {
    // All modules depend on the core
    implementation project(':core')
    implementation project(':voidalchemy')
    implementation project(':eldritchartifacts')
    implementation project(':obsidianforgemaster')
    implementation project(':voidcorruption')
    implementation project(':eldritcharcana')
    implementation project(':obsidianconstructs')
}

// Shadow jar task to create a fat jar with all dependencies
jar {
    from {
        configurations.runtimeClasspath.collect { 
            it.isDirectory() ? it : zipTree(it).matching {
                // Exclude META-INF that would conflict
                exclude("META-INF/MANIFEST.MF") 
                exclude("META-INF/LICENSE")
                exclude("META-INF/*.RSA")
                exclude("META-INF/*.SF")
            }
        }
    }
    
    manifest {
        attributes([
            "Specification-Title": "Eldritch Void - Complete Package",
            "Specification-Vendor": project.mod_authors,
            "Specification-Version": "1",
            "Implementation-Title": "Eldritch Void - Complete Package",
            "Implementation-Version": project.mod_version,
            "Implementation-Vendor": project.mod_authors,
            "Implementation-Timestamp": new Date().format("yyyy-MM-dd'T'HH:mm:ssZ")
        ])
    }
    
    // Avoid potential duplicate file entries
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// Create a special neoforge.mods.toml for the all-in-one jar
task createAllModsToml {
    doLast {
        mkdir 'src/main/resources/META-INF'
        file('src/main/resources/META-INF/neoforge.mods.toml').text = """# This is the NeoForge mods.toml file for Eldritch Void All-in-One
# Documentation: https://neoforged.net/docs/configuration/mods.toml/

modLoader="javafml"
loaderVersion="[7,)"
license="MIT"
issueTrackerURL="https://github.com/yourusername/eldritchvoid/issues"

[[mods]]
modId="eldritchvoid"
version="$project.version"
displayName="Eldritch Void - Complete"
updateJSONURL="https://example.com/updates.json"
displayURL="https://example.com/eldritchvoid"
logoFile="logo.png"
credits="Thanks to all contributors and the NeoForge team"
authors="$project.mod_authors"
description='''
A comprehensive modular Minecraft mod for NeoForge 1.21.5 featuring all integrated modules centered around Eldritch, Void, and Obsidian themes with Thaumcraft inspiration.

This is the all-in-one package containing all modules: Void Alchemy, Obsidian Forgemaster, Eldritch Artifacts, Void Corruption, Eldritch Arcana, Obsidian Constructs, and more.
'''

[[dependencies.eldritchvoid]]
    modId="minecraft"
    mandatory=true
    versionRange="[1.21.5,1.22)"
    ordering="NONE"
    side="BOTH"

[[dependencies.eldritchvoid]]
    modId="neoforge"
    mandatory=true
    versionRange="[21.5.0,22.0.0)"
    ordering="NONE"
    side="BOTH"
"""
    }
}

processResources.dependsOn createAllModsToml